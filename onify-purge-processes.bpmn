<?xml version="1.0" encoding="UTF-8"?>
<bpmn:definitions xmlns:bpmn="http://www.omg.org/spec/BPMN/20100524/MODEL" xmlns:bpmndi="http://www.omg.org/spec/BPMN/20100524/DI" xmlns:dc="http://www.omg.org/spec/DD/20100524/DC" xmlns:camunda="http://camunda.org/schema/1.0/bpmn" xmlns:xsi="http://www.w3.org/2001/XMLSchema-instance" xmlns:bioc="http://bpmn.io/schema/bpmn/biocolor/1.0" xmlns:color="http://www.omg.org/spec/BPMN/non-normative/color/1.0" xmlns:di="http://www.omg.org/spec/DD/20100524/DI" xmlns:modeler="http://camunda.org/schema/modeler/1.0" id="Definitions_1l06257" targetNamespace="http://bpmn.io/schema/bpmn" exporter="Camunda Modeler" exporterVersion="5.10.0" modeler:executionPlatform="Camunda Platform" modeler:executionPlatformVersion="7.19.0">
  <bpmn:process id="onify-purge-processes" name="Purge processes in Onify" isExecutable="true">
    <bpmn:startEvent id="StartEvent_1" name="Start purge of processes">
      <bpmn:outgoing>Flow_0opnotj</bpmn:outgoing>
    </bpmn:startEvent>
    <bpmn:endEvent id="Event_1ng1lsi" name="Finished purging processes">
      <bpmn:incoming>Flow_18ey5tp</bpmn:incoming>
    </bpmn:endEvent>
    <bpmn:serviceTask id="getProcesses" name="Get processes">
      <bpmn:extensionElements>
        <camunda:inputOutput>
          <camunda:outputParameter name="processes">${content.output.body.records}</camunda:outputParameter>
          <camunda:outputParameter name="nextUrl">${content.output.body.meta.nexturl}</camunda:outputParameter>
          <camunda:outputParameter name="meta">${content.output.body.meta}</camunda:outputParameter>
        </camunda:inputOutput>
        <camunda:connector>
          <camunda:inputOutput>
            <camunda:inputParameter name="url">
              <camunda:script scriptFormat="js">let url = environment.output?.nextUrl ? environment.output.nextUrl : "/admin/processes?startfrom=0&amp;pagesize=100&amp;query=tag:purge";
next(null, url);</camunda:script>
            </camunda:inputParameter>
          </camunda:inputOutput>
          <camunda:connectorId>onifyApiRequest</camunda:connectorId>
        </camunda:connector>
      </bpmn:extensionElements>
      <bpmn:incoming>Flow_1sov5ht</bpmn:incoming>
      <bpmn:incoming>Flow_0opnotj</bpmn:incoming>
      <bpmn:outgoing>Flow_1lvti4x</bpmn:outgoing>
    </bpmn:serviceTask>
    <bpmn:exclusiveGateway id="Gateway_1hl0imf" name="More processes?">
      <bpmn:incoming>Flow_0q6hkuu</bpmn:incoming>
      <bpmn:outgoing>Flow_1sov5ht</bpmn:outgoing>
      <bpmn:outgoing>Flow_18ey5tp</bpmn:outgoing>
    </bpmn:exclusiveGateway>
    <bpmn:sequenceFlow id="Flow_1sov5ht" name="Yes" sourceRef="Gateway_1hl0imf" targetRef="getProcesses">
      <bpmn:conditionExpression xsi:type="bpmn:tFormalExpression" language="js">next(null, environment.output.nextUrl);</bpmn:conditionExpression>
    </bpmn:sequenceFlow>
    <bpmn:sequenceFlow id="Flow_1lvti4x" sourceRef="getProcesses" targetRef="purgeProcesses" />
    <bpmn:sequenceFlow id="Flow_0opnotj" sourceRef="StartEvent_1" targetRef="getProcesses" />
    <bpmn:sequenceFlow id="Flow_18ey5tp" name="No" sourceRef="Gateway_1hl0imf" targetRef="Event_1ng1lsi">
      <bpmn:conditionExpression xsi:type="bpmn:tFormalExpression" language="js">next(null, !environment.output.nextUrl);</bpmn:conditionExpression>
    </bpmn:sequenceFlow>
    <bpmn:sequenceFlow id="Flow_0q6hkuu" sourceRef="purgeProcesses" targetRef="Gateway_1hl0imf" />
    <bpmn:subProcess id="purgeProcesses" name="Purge processes">
      <bpmn:incoming>Flow_1lvti4x</bpmn:incoming>
      <bpmn:outgoing>Flow_0q6hkuu</bpmn:outgoing>
      <bpmn:multiInstanceLoopCharacteristics isSequential="true" camunda:collection="${environment.output.processes}" camunda:elementVariable="process" />
      <bpmn:startEvent id="Event_08kghjk">
        <bpmn:outgoing>Flow_1gxnt86</bpmn:outgoing>
      </bpmn:startEvent>
      <bpmn:endEvent id="Event_0fafn3c">
        <bpmn:incoming>Flow_18um7tp</bpmn:incoming>
      </bpmn:endEvent>
      <bpmn:sequenceFlow id="Flow_1gxnt86" sourceRef="Event_08kghjk" targetRef="Activity_107q51t" />
      <bpmn:sequenceFlow id="Flow_1d15wj8" sourceRef="Activity_107q51t" targetRef="Activity_0p6t42t" />
      <bpmn:scriptTask id="Activity_107q51t" name="Print process" scriptFormat="js">
        <bpmn:incoming>Flow_1gxnt86</bpmn:incoming>
        <bpmn:outgoing>Flow_1d15wj8</bpmn:outgoing>
        <bpmn:script>console.log(environment.variables.content.process);
next();</bpmn:script>
      </bpmn:scriptTask>
      <bpmn:sequenceFlow id="Flow_18um7tp" sourceRef="Activity_0p6t42t" targetRef="Event_0fafn3c" />
      <bpmn:scriptTask id="Activity_0p6t42t" name="Extract purge attributes" scriptFormat="js">
        <bpmn:incoming>Flow_1d15wj8</bpmn:incoming>
        <bpmn:outgoing>Flow_18um7tp</bpmn:outgoing>
        <bpmn:script>const process = environment.variables.content.process;
const foundString = process.tag.find(tag =&gt; tag.startsWith('purge:'));
console.log(foundString);
next();</bpmn:script>
      </bpmn:scriptTask>
    </bpmn:subProcess>
  </bpmn:process>
  <bpmndi:BPMNDiagram id="BPMNDiagram_1">
    <bpmndi:BPMNPlane id="BPMNPlane_1" bpmnElement="onify-purge-processes">
      <bpmndi:BPMNShape id="_BPMNShape_StartEvent_2" bpmnElement="StartEvent_1" bioc:stroke="#43a047" bioc:fill="#c8e6c9" color:background-color="#c8e6c9" color:border-color="#43a047">
        <dc:Bounds x="179" y="79" width="36" height="36" />
        <bpmndi:BPMNLabel>
          <dc:Bounds x="163" y="122" width="68" height="27" />
        </bpmndi:BPMNLabel>
      </bpmndi:BPMNShape>
      <bpmndi:BPMNShape id="Activity_0t1oqzv_di" bpmnElement="getProcesses">
        <dc:Bounds x="370" y="57" width="100" height="80" />
        <bpmndi:BPMNLabel />
      </bpmndi:BPMNShape>
      <bpmndi:BPMNShape id="Event_1ng1lsi_di" bpmnElement="Event_1ng1lsi" bioc:stroke="#e53935" bioc:fill="#ffcdd2" color:background-color="#ffcdd2" color:border-color="#e53935">
        <dc:Bounds x="992" y="79" width="36" height="36" />
        <bpmndi:BPMNLabel>
          <dc:Bounds x="969" y="122" width="82" height="27" />
        </bpmndi:BPMNLabel>
      </bpmndi:BPMNShape>
      <bpmndi:BPMNShape id="Gateway_1hl0imf_di" bpmnElement="Gateway_1hl0imf" isMarkerVisible="true">
        <dc:Bounds x="825" y="72" width="50" height="50" />
        <bpmndi:BPMNLabel>
          <dc:Bounds x="807" y="48" width="85" height="14" />
        </bpmndi:BPMNLabel>
      </bpmndi:BPMNShape>
      <bpmndi:BPMNShape id="Activity_1ps0p0d_di" bpmnElement="purgeProcesses">
        <dc:Bounds x="580" y="57" width="100" height="80" />
        <bpmndi:BPMNLabel />
      </bpmndi:BPMNShape>
      <bpmndi:BPMNEdge id="Flow_1sov5ht_di" bpmnElement="Flow_1sov5ht">
        <di:waypoint x="850" y="122" />
        <di:waypoint x="850" y="240" />
        <di:waypoint x="420" y="240" />
        <di:waypoint x="420" y="137" />
        <bpmndi:BPMNLabel>
          <dc:Bounds x="821" y="169" width="18" height="14" />
        </bpmndi:BPMNLabel>
      </bpmndi:BPMNEdge>
      <bpmndi:BPMNEdge id="Flow_1lvti4x_di" bpmnElement="Flow_1lvti4x">
        <di:waypoint x="470" y="97" />
        <di:waypoint x="580" y="97" />
      </bpmndi:BPMNEdge>
      <bpmndi:BPMNEdge id="Flow_0opnotj_di" bpmnElement="Flow_0opnotj">
        <di:waypoint x="215" y="97" />
        <di:waypoint x="370" y="97" />
      </bpmndi:BPMNEdge>
      <bpmndi:BPMNEdge id="Flow_18ey5tp_di" bpmnElement="Flow_18ey5tp">
        <di:waypoint x="875" y="97" />
        <di:waypoint x="992" y="97" />
        <bpmndi:BPMNLabel>
          <dc:Bounds x="926" y="79" width="15" height="14" />
        </bpmndi:BPMNLabel>
      </bpmndi:BPMNEdge>
      <bpmndi:BPMNEdge id="Flow_0q6hkuu_di" bpmnElement="Flow_0q6hkuu">
        <di:waypoint x="680" y="97" />
        <di:waypoint x="825" y="97" />
      </bpmndi:BPMNEdge>
    </bpmndi:BPMNPlane>
  </bpmndi:BPMNDiagram>
  <bpmndi:BPMNDiagram id="BPMNDiagram_1crw8vn">
    <bpmndi:BPMNPlane id="BPMNPlane_0sozb0y" bpmnElement="purgeProcesses">
      <bpmndi:BPMNShape id="Event_08kghjk_di" bpmnElement="Event_08kghjk">
        <dc:Bounds x="122" y="102" width="36" height="36" />
      </bpmndi:BPMNShape>
      <bpmndi:BPMNShape id="Activity_0yohfze_di" bpmnElement="Activity_107q51t">
        <dc:Bounds x="250" y="80" width="100" height="80" />
        <bpmndi:BPMNLabel />
      </bpmndi:BPMNShape>
      <bpmndi:BPMNShape id="Event_0fafn3c_di" bpmnElement="Event_0fafn3c">
        <dc:Bounds x="572" y="102" width="36" height="36" />
      </bpmndi:BPMNShape>
      <bpmndi:BPMNShape id="Activity_02mtgin_di" bpmnElement="Activity_0p6t42t">
        <dc:Bounds x="400" y="80" width="100" height="80" />
      </bpmndi:BPMNShape>
      <bpmndi:BPMNEdge id="Flow_1gxnt86_di" bpmnElement="Flow_1gxnt86">
        <di:waypoint x="158" y="120" />
        <di:waypoint x="250" y="120" />
      </bpmndi:BPMNEdge>
      <bpmndi:BPMNEdge id="Flow_1d15wj8_di" bpmnElement="Flow_1d15wj8">
        <di:waypoint x="350" y="120" />
        <di:waypoint x="400" y="120" />
      </bpmndi:BPMNEdge>
      <bpmndi:BPMNEdge id="Flow_18um7tp_di" bpmnElement="Flow_18um7tp">
        <di:waypoint x="500" y="120" />
        <di:waypoint x="572" y="120" />
      </bpmndi:BPMNEdge>
    </bpmndi:BPMNPlane>
  </bpmndi:BPMNDiagram>
</bpmn:definitions>
